<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rugby Coaching Tool</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls {
      padding: 10px;
    }

    button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }

    #field {
      position: relative;
      background: url('H.png') no-repeat center center;
      background-size: cover;
      width: 1000px;
      height: 600px;
      border: 3px solid #fff;
      overflow: hidden;
    }

    .player, .defender {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: blue;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      cursor: pointer;
      user-select: none;
      transition: top 0.4s ease, left 0.4s ease;
      font-weight: bold;
    }

    .defender {
      background: red;
    }

    .tackled {
      background: darkred !important;
    }

    .ball {
      font-size: 20px;
      width: 30px;
      height: 30px;
      position: absolute;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      transition: top 0.4s ease, left 0.4s ease;
    }
  </style>
</head>
<body>

  <div id="controls">
    <button onclick="addPlayer('attacker')">Add Attacker</button>
    <button onclick="addPlayer('defender')">Add Defender</button>
    <button onclick="addBall()">Add Ball</button>
    <button onclick="saveStep()">Save Step</button>
    <button onclick="undoStep()">Undo</button>
    <button onclick="resetField()">Reset</button>
  </div>

  <div id="field"></div>

  <script>
    const field = document.getElementById('field');
    let stepHistory = [];
    let playerCount = 0;
    let defenderCount = 0;
    let ball;

    function addPlayer(type) {
      const player = document.createElement('div');
      player.classList.add(type === 'attacker' ? 'player' : 'defender');
      player.textContent = type === 'attacker' ? ++playerCount : ++defenderCount;
      player.style.left = `${field.clientWidth / 2 - 20}px`;
      player.style.top = `${field.clientHeight / 2 - 20}px`;
      field.appendChild(player);
      makeDraggable(player);
    }

    function addBall() {
      if (ball) return; // only one ball allowed
      ball = document.createElement('div');
      ball.classList.add('ball');
      ball.textContent = '🏉';
      ball.style.left = `${field.clientWidth / 2 - 15}px`;
      ball.style.top = `${field.clientHeight / 2 - 15}px`;
      field.appendChild(ball);
      makeDraggable(ball);
    }

    function makeDraggable(el) {
      let offsetX, offsetY, isDragging = false;

      el.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        el.style.zIndex = 1000;
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const x = e.pageX - field.offsetLeft - offsetX;
        const y = e.pageY - field.offsetTop - offsetY;
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        if (el.classList.contains('player')) checkTackles();
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        el.style.zIndex = '';
      });
    }

    function checkTackles() {
      const players = Array.from(field.querySelectorAll('.player'));
      const defenders = Array.from(field.querySelectorAll('.defender'));
      players.forEach(p => {
        const px = parseInt(p.style.left);
        const py = parseInt(p.style.top);
        let tackled = false;
        defenders.forEach(d => {
          const dx = parseInt(d.style.left);
          const dy = parseInt(d.style.top);
          const dist = Math.sqrt((px - dx) ** 2 + (py - dy) ** 2);
          if (dist < 50) tackled = true;
        });
        if (tackled) {
          p.classList.add('tackled');
        } else {
          p.classList.remove('tackled');
        }
      });
    }

    function saveStep() {
      const positions = Array.from(field.children).map(el => ({
        class: el.className,
        left: el.style.left,
        top: el.style.top,
        text: el.textContent
      }));
      stepHistory.push(positions);
    }

    function undoStep() {
      if (stepHistory.length < 1) return;
      const lastStep = stepHistory.pop();
      field.innerHTML = '';
      ball = null;
      playerCount = 0;
      defenderCount = 0;
      lastStep.forEach(item => {
        const el = document.createElement('div');
        el.className = item.class;
        el.textContent = item.text;
        el.style.left = item.left;
        el.style.top = item.top;
        if (el.classList.contains('player')) playerCount++;
        if (el.classList.contains('defender')) defenderCount++;
        if (el.classList.contains('ball')) ball = el;
        field.appendChild(el);
        makeDraggable(el);
      });
      checkTackles();
    }

    function resetField() {
      field.innerHTML = '';
      ball = null;
      playerCount = 0;
      defenderCount = 0;
      stepHistory = [];
    }
  </script>
</body>
</html>
