<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rugby Play Simulator</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      user-select: none;
    }
    #field {
      width: 100vw;
      height: 100vh;
      background-image: url("H.png");
      background-size: cover;
      position: relative;
      overflow: hidden;
    }
    .player, .ball {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      cursor: grab;
      transition: top 0.7s ease, left 0.7s ease;
    }
    .attacking {
      background-color: blue;
    }
    .defending {
      background-color: red;
    }
    .ball {
      background-color: orange;
    }
    .tackled {
      background-color: darkred !important;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 8px;
      z-index: 10;
    }
    .controls button, .controls select {
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="addPlayer('attacking')">Add Attacker</button>
    <button onclick="addPlayer('defending')">Add Defender</button>
    <button onclick="addBall()">Add Ball</button>
    <button onclick="saveStep()">Save Step</button>
    <button onclick="playSteps()">Play</button>
    <button onclick="undoStep()">Undo</button>
    <button onclick="resetField()">Reset</button>
    <label for="speed">Speed:</label>
    <select id="speed">
      <option value="700">1x</option>
      <option value="1400">0.5x</option>
      <option value="350">2x</option>
    </select>
  </div>
  <div id="field"></div>

  <script>
    const field = document.getElementById("field");
    let currentId = 0;
    let steps = [];

    function createDraggable(type, id) {
      const el = document.createElement("div");
      el.classList.add(type);
      el.classList.add(type === "ball" ? "ball" : "player");
      el.setAttribute("data-id", id);
      if (type !== "ball") el.innerText = id;
      field.appendChild(el);

      el.onmousedown = (e) => {
        let shiftX = e.clientX - el.getBoundingClientRect().left;
        let shiftY = e.clientY - el.getBoundingClientRect().top;

        function moveAt(pageX, pageY) {
          el.style.left = pageX - shiftX + "px";
          el.style.top = pageY - shiftY + "px";
          checkTackles();
        }

        function onMouseMove(e) {
          moveAt(e.pageX, e.pageY);
        }

        document.addEventListener("mousemove", onMouseMove);

        el.onmouseup = () => {
          document.removeEventListener("mousemove", onMouseMove);
          el.onmouseup = null;
        };
      };
    }

    function addPlayer(type) {
      if (document.querySelectorAll("." + type).length >= 15) return;
      currentId++;
      createDraggable(type, currentId);
    }

    function addBall() {
      if (document.querySelector(".ball")) return;
      createDraggable("ball", "B");
    }

    function saveStep() {
      const snapshot = [];
      document.querySelectorAll(".player, .ball").forEach((el) => {
        snapshot.push({
          id: el.getAttribute("data-id"),
          type: el.classList.contains("ball") ? "ball" : el.classList.contains("attacking") ? "attacking" : "defending",
          top: el.style.top,
          left: el.style.left
        });
      });
      steps.push(snapshot);
    }

    function undoStep() {
      if (steps.length > 0) {
        steps.pop();
      }
    }

    function resetField() {
      document.querySelectorAll(".player, .ball").forEach((el) => el.remove());
      steps = [];
      currentId = 0;
    }

    function playSteps() {
      let delay = 0;
      const speed = parseInt(document.getElementById("speed").value);
      steps.forEach((snapshot, i) => {
        setTimeout(() => {
          snapshot.forEach((pos) => {
            let el = document.querySelector(`[data-id='${pos.id}']`);
            if (!el) {
              createDraggable(pos.type, pos.id);
              el = document.querySelector(`[data-id='${pos.id}']`);
            }
            el.style.top = pos.top;
            el.style.left = pos.left;
          });
          checkTackles();
        }, delay);
        delay += speed;
      });
    }

    function checkTackles() {
      const attackers = document.querySelectorAll(".attacking");
      const defenders = document.querySelectorAll(".defending");

      attackers.forEach((att) => att.classList.remove("tackled"));

      attackers.forEach((att) => {
        const aRect = att.getBoundingClientRect();
        defenders.forEach((def) => {
          const dRect = def.getBoundingClientRect();
          const dx = aRect.left - dRect.left;
          const dy = aRect.top - dRect.top;
          const distance = Math.sqrt(dx * dx + dy * dy);
          if (distance < 35) {
            att.classList.add("tackled");
          }
        });
      });
    }
  </script>
</body>
</html>
