<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rugby Play Designer</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    #field {
      background-image: url('H.png');
      background-size: cover;
      background-position: center;
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    .player, .defender, .ball {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      position: absolute;
      cursor: pointer;
      user-select: none;
    }
    .player {
      background-color: red;
    }
    .defender {
      background-color: blue;
    }
    .ball {
      background: none;
      font-size: 24px;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
    button {
      margin: 5px;
    }
    .tackle {
      border: 2px solid yellow;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="addPlayer('player')">Add Attacker</button>
    <button onclick="addPlayer('defender')">Add Defender</button>
    <button onclick="addBall()">Add Ball</button>
    <button onclick="saveStep()">Save Step</button>
    <button onclick="undoStep()">Undo</button>
    <button onclick="resetField()">Reset</button>
    <button onclick="downloadMP4()">Export MP4</button>
  </div>
  <div id="field"></div>

  <script>
    const field = document.getElementById("field");
    const steps = [];
    let dragging = null;
    let offsetX = 0;
    let offsetY = 0;
    let playerCount = 0;
    let defenderCount = 0;
    let ballExists = false;

    field.addEventListener("mousedown", (e) => {
      if (e.target.classList.contains("player") || e.target.classList.contains("defender") || e.target.classList.contains("ball")) {
        dragging = e.target;
        const rect = dragging.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
      }
    });

    field.addEventListener("mouseup", () => {
      dragging = null;
    });

    field.addEventListener("mousemove", (e) => {
      if (dragging) {
        dragging.style.left = `${e.clientX - offsetX}px`;
        dragging.style.top = `${e.clientY - offsetY}px`;
      }
    });

    function addPlayer(type) {
      const div = document.createElement("div");
      div.classList.add(type);
      const count = type === "player" ? ++playerCount : ++defenderCount;
      div.innerText = count;
      div.style.left = `${window.innerWidth / 2 - 20}px`;
      div.style.top = `${window.innerHeight / 2 - 20}px`;
      div.addEventListener("dblclick", () => {
        if (type === "player" && div.classList.contains("player")) {
          div.classList.toggle("tackle");
        }
      });
      field.appendChild(div);
    }

    function addBall() {
      if (ballExists) return;
      const div = document.createElement("div");
      div.classList.add("ball");
      div.innerText = "🏉";
      div.style.left = `${window.innerWidth / 2 - 20}px`;
      div.style.top = `${window.innerHeight / 2 - 20}px`;
      field.appendChild(div);
      ballExists = true;
    }

    function saveStep() {
      const step = [];
      document.querySelectorAll(".player, .defender, .ball").forEach((el) => {
        step.push({
          class: el.className,
          text: el.innerText,
          left: el.style.left,
          top: el.style.top,
        });
      });
      steps.push(step);
    }

    function undoStep() {
      if (steps.length > 0) {
        const lastStep = steps.pop();
        field.innerHTML = "";
        document.body.appendChild(document.getElementById("controls"));
        ballExists = false;
        lastStep.forEach((item) => {
          const div = document.createElement("div");
          div.className = item.class;
          div.innerText = item.text;
          div.style.left = item.left;
          div.style.top = item.top;
          if (item.class.includes("ball")) ballExists = true;
          div.addEventListener("dblclick", () => {
            if (div.classList.contains("player")) {
              div.classList.toggle("tackle");
            }
          });
          field.appendChild(div);
        });
      }
    }

    function resetField() {
      document.querySelectorAll(".player, .defender, .ball").forEach((el) => el.remove());
      steps.length = 0;
      playerCount = 0;
      defenderCount = 0;
      ballExists = false;
    }

    function downloadMP4() {
      alert("For now, use a screen recording tool to export to MP4. Built-in export coming soon!");
    }
  </script>
</body>
</html>
